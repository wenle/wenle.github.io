---
layout: post
title: 短网址服务的设计与实现
categories: 系统架构
tags: 互联网
---

#### 场景
短网址服务是用户输入一个URL，短网址平台将之转换为一个短网址。当用户访问这个短网址的时候，将跳转到真正的URL。举个例子，新浪微博上的一个秒拍视频的短网址是`http://t.cn/RGYgwjI`，点击这个网址，最终访问的地址是`http://weibo.com/p/2304448ff19dbfa43927408deaed469083b04e`。

#### 网址的地址空间
短网址服务的核心问题是长网址到短网址的相互转换。比如新浪的这个短网址服务，假定它的后缀最大长度为7位。（这里必然是个位数的长度，不然就称不上短了。）如果我们不使用奇奇怪怪的字符，只用大小写英文字母，数字0到9，那么短网址的总个数是`(26*2+10)^7=3521614606208`。哇，数了数，有3.5万亿个！

我们再算算，一个URL可以有多长。URL的最大长度，各个浏览器和web服务器都有不同的限制，最小的也有两千多个字符。这里使用IE的2038限制。不考虑URL允许的字符比短网址要多，即使按`62^2038`算，URL的地址空间所能容纳的URL个数是一个天文数字。

#### 映射的实现
显而易见，不存在一个算法，可以实现可逆的互相转换。采用一个看起来笨一点的办法，可以把映射关系保存起来。需要转换的时候来查询，这样的话总共能支持的URL总数也就是3.5万亿。假定一个短网址的有效期为1年，那么理论上7位短网址可以支持每秒分配`3521614606208/(365*24*60*60)=111669`个新短网址!

再考虑短网址的应用场景，短网址最初出现在twitter，因为节省空间，方便传播，但它并不利于阅读。从一个短网址看不出网站的网址，也看不出网页的内容大概是什么。所以：

1. 短网址的查询远远多于创建
2. 用短网址进行传播的网页相对于整个地址空间来说占比很小
3. 短网址不需要很久的有效期，用户一般收藏实际网址而不是短网址

从上面的计算可以看出来，7位字符的短网址，可以使用很长时间。在短网址空间为使用满之前，实际上是不需要着急清理过期的短网址的，所以过期删除的操作完全可以根据资源和负载来动态调度。

分配短网址为了不重复，可以采用自增的形式，就按照`0<9<a<z<A<Z`的顺序，第一个短网址是0000000，最后一个短网址是ZZZZZZZ。

#### 进一步优化
一个热门的网页会有很多人创建短网址分享出去，同时也会有很多人在点击分享出来的短网址。缓存是一个合理的优化方案。无论是创建短网址的请求，还是查询短网址的请求，都可以先查询一遍内存的缓存。

另外，对于相同网页的重复创建短网址的请求，不需要保证总是返回同样的短网址。在缓存中没有查到已分配的记录时，完全可以每个请求都分配一个新的短网址，这样的好处是不需要根据长网址去查询短网址，因为在长网址（数据库上大字符字段）上查询效率比较低。

进一步，可以做一个简单的7位字符到数字的映射，这样就可以在数据库里使用自增数字，以提高索引查询的效率。以数字作为分库分表的key效率也更高。按照`0<9<a<z<A<Z`的顺序，可以将字符映射到0~61，7位的短网址相当于一个7位的62进制数字。

#### 最后
别忘了申请一个短域名作为短网址的平台，方便的短域名必然很贵。
